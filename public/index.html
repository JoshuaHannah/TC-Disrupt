<!DOCTYPE HTML>
<html>

<head>

<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">

<!--JS-->
<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="chart.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>

<!--CSS-->
<link rel="stylesheet" href="http://js.arcgis.com/3.11/dijit/themes/claro/claro.css">
<link href='http://fonts.googleapis.com/css?family=Cabin:400,400italic' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="http://js.arcgis.com/3.11/esri/css/esri.css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
<link rel="stylesheet" href="style.css">

<script>var dojoConfig = {parseOnLoad: true};</script>
    <script src="http://js.arcgis.com/3.11/"></script>
    <script>
		 //dojo.require("esri.layers.WebTiledLayer");
		 //wtl = esri.layers.WebTiledLayer;

	var data = {
    labels: ["Taimur", "Lukas", "Josh", "Lewis"],
    datasets: [
        {
            label: "My First dataset",
            fillColor: "rgba(220,220,220,0.5)",
            strokeColor: "rgba(220,220,220,0.8)",
            highlightFill: "rgba(220,220,220,0.75)",
            highlightStroke: "rgba(220,220,220,1)",
            data: [1500,1500,1500,1500]
        }
    ]
};

	 var map;
	 var point;
	 var coords;
	 var symbol;
	 var layer;
	 var graphic;
	 var myBarChart;
	 var ctx;
       
 
        require(["esri/map", "esri/Color", "esri/graphic",  "esri/layers/FeatureLayer","esri/symbols/SimpleLineSymbol", "esri/symbols/SimpleFillSymbol", "esri/renderers/UniqueValueRenderer"],
        function( Map, Color, Graphic, FeatureLayer, SimpleLineSymbol, SimpleFillSymbol, UniqueValueRenderer) {
               
        map = new Map("map", {
          center:[-0.1299583,51.509029],
                  basemap: "gray",
          zoom: 15
        });

        map.on("load", addFeatureLayer);

        map.on("click", function(event){
        	layer.remove(graphic);
        	coords = esri.geometry.webMercatorToGeographic(event.mapPoint);

        	$.ajax({
        		type: 'GET',
        		url: '/position',
        		data: {username: 'Taimur', lng: coords.x, lat: coords.y},
        	}).done(function(res){
        		if(res.msg == 'OK'){

        		}
        		if(res.msg == 'BOUGHT'){
        			$('.feed').append('<li>You bought <i>'+res.street+'</i>.</li>');
        		}
        		if(res.msg == 'GAME OVER'){

        		}
        		if(res.msg == 'PAYED RENT'){
        			$('.feed').append('<ul>You had to pay '+res.amount+ 'for landing on '+res.street+'.</ul>');
        		}
        	})

        	$.ajax({
        		type: 'GET',
        		url: '/data',
        		data: {},
        	}).done(function(res){
        		console.log(res);
        		data.datasets[0].data = [res['Taimur'].money, res['Lukas'].money, res['Josh'].money, res['Lewis'].money];
        		console.log(data.datasets[0].data);
        		ctx = document.getElementById("myChart").getContext("2d");
				myBarChart = new Chart(ctx).Bar(data);
        	})

        	point = new esri.geometry.Point(coords.x,coords.y);
        	graphic = new esri.Graphic(point, symbol);
        	layer.add(graphic);
			map.addLayer(layer);
        });
 
        function addFeatureLayer() {
                        var defaultSymbol = new SimpleFillSymbol().setStyle(SimpleFillSymbol.STYLE_NULL);
                          defaultSymbol.outline.setStyle(SimpleLineSymbol.STYLE_NULL);
                         // https://a.tiles.mapbox.com/v4/tcdisrupt.k04hc88j/page.html?access_token=pk.eyJ1IjoidGNkaXNydXB0IiwiYSI6Ind2RjdORGcifQ.EMT4hNFxEd5cwWg1mro7Mw#15/51.5137/-0.0844
                         var renderer = new UniqueValueRenderer(defaultSymbol, "colour");      
                         
                          var featureLayer = new FeatureLayer("http://services.arcgis.com/XCbo5t7BF3Awl0lX/arcgis/rest/services/MonopolyStreets/FeatureServer/0", { mode: FeatureLayer.MODE_ONDEMAND, outFields: ["colour"] })
                          renderer.addValue("brown", new SimpleFillSymbol().setColor(new Color([97, 73, 0, 0.7])));
                          renderer.addValue("orange", new SimpleFillSymbol().setColor(new Color([236, 139, 44, 0.7])));
                          renderer.addValue("yellow", new SimpleFillSymbol().setColor(new Color([255, 240, 4, 0.7])));
                          renderer.addValue("red", new SimpleFillSymbol().setColor(new Color([219, 36, 39, 0.7])));
                          renderer.addValue("green", new SimpleFillSymbol().setColor(new Color([0, 129, 59, 0.7])));
                          renderer.addValue("purple", new SimpleFillSymbol().setColor(new Color([97, 0, 86, 0.7])));
                          renderer.addValue("blue", new SimpleFillSymbol().setColor(new Color([0, 102, 164, 0.7])));
                          renderer.addValue("pink", new SimpleFillSymbol().setColor(new Color([197, 56, 132, 0.7])));
                          renderer.addValue("black", new SimpleFillSymbol().setColor(new Color([0, 0, 0, 0.7])));
                               
                               
                          featureLayer.setRenderer(renderer);
                         map.addLayer(featureLayer);
                         }

                        point = new esri.geometry.Point(-0.1299583,51.509029);
						point = esri.geometry.geographicToWebMercator(point);
						symbol = new esri.symbol.PictureMarkerSymbol("icon-1.png", 26, 26);
						graphic = new esri.Graphic(point, symbol);
						layer = new esri.layers.GraphicsLayer();
						layer.add(graphic);
						map.addLayer(layer);

						point2 = new esri.geometry.Point(-0.1299583,51.509029);
						point2 = esri.geometry.geographicToWebMercator(point);
						symbol2 = new esri.symbol.PictureMarkerSymbol("icon-1.png", 26, 26);
						graphic2 = new esri.Graphic(point, symbol);
						layer2 = new esri.layers.GraphicsLayer();
						layer2.add(graphic2);
						map.addLayer(layer2);

       
      });

	$(document).ready(function(){

		ctx = document.getElementById("myChart").getContext("2d");
		myBarChart = new Chart(ctx).Bar(data);

	})

    </script>

</head>

<body class="claro">

<div class="row">

<div class="col-md-9 mapcolumn">

<div id="map" class="map"></div>

</div>

<div class="col-md-3 optionscolumn">

	<img class="logo" src="logo.png">

	<div class="players">

		<h3>Game Stats</h3>

		<canvas id="myChart" width="260" height="200"></canvas>

	</div>

	<div class="feed">

		<h3>Feed</h3>

	</div>

</div>

</div>

</body>

</html>